<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Video krone</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden;cursor:none}
  video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
</style>
</head>
<body>
  <video id="v" autoplay muted playsinline preload="auto" crossorigin="anonymous"></video>
  <script>
    const playlist = [
      "Kronegrafikk-1.mp4",
      "Kronegrafikk-2.mp4",
      "Kronegrafikk-3.mp4"
    ];

    const v = document.getElementById("v");
    let i = 0;
    let retries = 0;
    let loadTimer = null;

    function log(...args){ try{ console.log(...args); }catch(_){} }

    function next() {
      clearTimeout(loadTimer);
      retries = 0;
      i = (i + 1) % playlist.length;
      play(i);
    }

    function play(index) {
      clearTimeout(loadTimer);
      const src = playlist[index];
      log("Loading", src);
      v.pause();
      v.removeAttribute("src");
      v.load(); // reset state
      v.src = src;          // if cross-domain, ensure CORS headers server-side
      v.currentTime = 0;
      v.play().catch(()=>{ /* will often resolve once ready */ });

      // If nothing loads within 8s, skip
      loadTimer = setTimeout(() => {
        log("Timeout waiting for video to load:", src);
        handleError();
      }, 8000);
    }

    function handleError() {
      clearTimeout(loadTimer);
      if (retries < 1) {
        retries++;
        log("Retrying", playlist[i], "retry", retries);
        play(i);
      } else {
        log("Skipping broken video:", playlist[i]);
        next();
      }
    }

    // Advance on natural end
    v.addEventListener("ended", next);

    // Robust error handling
    ["error","stalled","abort","emptied","suspend","waiting"].forEach(ev =>
      v.addEventListener(ev, () => {
        log("Video event:", ev, "readyState", v.readyState, "networkState", v.networkState);
        // If we already started playing and hit 'waiting', let it buffer.
        // If we haven't loaded enough (readyState < 2), treat as error.
        if (v.readyState < 2) handleError();
      })
    );

    // When it's actually ready, clear the timeout
    v.addEventListener("loadeddata", () => {
      clearTimeout(loadTimer);
      retries = 0;
      v.play().catch(()=>{});
    });

    // Kick off
    play(i);
  </script>
</body>
</html>
